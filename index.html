<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Availability Calendar</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; }
    label { margin-right: 10px; }
    select, input[type="text"], input[list] { margin-right: 20px; padding: 5px; }
    #userList { margin-left: 20px; display: flex; flex-wrap: wrap; }
    .user-item { display: inline-block; padding: 5px 10px; margin: 0 5px; background-color: #f0f0f0; border-radius: 4px; position: relative; cursor: pointer; }
    .user-item .remove-user { position: absolute; top: 2px; right: 4px; cursor: pointer; color: #900; font-weight: bold; }
    .new-user-btn { padding: 5px 10px; margin: 0 5px; background-color: #d0d0d0; border-radius: 4px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 5px; min-width: 60px; cursor: pointer; vertical-align: top; position: relative; }
    th { background-color: #f0f0f0; }
    td.disabled { cursor: default; }
    .status-good { background-color: #c8e6c9; }
    .status-notgreat { background-color: #ffe0b2; }
    .status-bad { background-color: #ffcdd2; }
    .user-label { display: block; font-size: 10px; }
    .json-area, .load-area { margin-top: 20px; }
    /* Rectangle around JSON pretty area */
    #jsonPretty {
      background: #fafafa;
      border: 1px solid #bbb;
      border-radius: 5px;
      padding: 12px;
      margin-top: 8px;
      margin-bottom: 8px;
      font-family: "Fira Mono", "Consolas", "Menlo", monospace;
      font-size: 14px;
      overflow-x: auto;
      white-space: pre;
    }
    button { margin-top: 5px; padding: 5px 10px; }
    .page-title { font-size: 2em; margin-bottom: 20px; }
    /* Simple JSON syntax highlighting */
    .json-key { color: #1a237e; }
    .json-string { color: #388e3c; }
    .json-number { color: #d84315; }
    .json-boolean { color: #6a1b9a; }
    .json-null { color: #616161; }
  </style>
</head>
<body>
  <div id="pageTitle" class="page-title"></div>

  <div style="margin-bottom:18px; padding:12px; background:#f9fbe7; border:1px solid #e6ee9c; border-radius:6px;">
    <b>Instructions:</b>
    <ul style="margin: 8px 0 8px 22px;">
      <li>Fill in your name</li>
      <li>Click on the calendar to mark times that are <span style="background:#ffe0b2; padding:2px 6px; border-radius:3px;">not great</span> or <span style="background:#ffcdd2; padding:2px 6px; border-radius:3px;">bad</span> for you to meet.</li>
      <li>When done, click <b>Copy Availability</b> and paste it into email to the organizer.</li>
    </ul>
    <div>
      <b>Legend: Time slot is </b>
      <span style="display:inline-block; background:#c8e6c9; width:18px; height:18px; border:1px solid #ccc; vertical-align:middle; margin:0 4px 0 12px;"></span> Good &nbsp;
      <span style="display:inline-block; background:#ffe0b2; width:18px; height:18px; border:1px solid #ccc; vertical-align:middle; margin:0 4px 0 12px;"></span> Not great &nbsp;
      <span style="display:inline-block; background:#ffcdd2; width:18px; height:18px; border:1px solid #ccc; vertical-align:middle; margin:0 4px 0 12px;"></span> Bad
    </div>
  </div>

  <div class="controls">
    <label for="timezoneInput">Timezone:</label>
    <input list="timezoneList" id="timezoneInput" placeholder="Search timezones">
    <datalist id="timezoneList"></datalist>
    <label for="nameInput">Name:</label>
    <input type="text" id="nameInput" placeholder="Your name">
    <div id="userList"></div>
  </div>

  <div id="calendarContainer"></div>

  <div class="json-area">
    <button id="copyJsonBtn">Copy Availability</button>
    <button id="copyUrlBtn">Copy URL</button>
    <label style="display:block; margin-top:10px;">Availability data (JSON):</label>
    <pre id="jsonPretty"></pre>
  </div>

  <div class="load-area">
      <label for="jsonInput">Paste availability JSON to merge:</label>
      <textarea id="jsonInput" placeholder='{"Alice": {"2025-06-01": {"08": "not great"}}}' style="height: 240px; width: 100%; box-sizing: border-box;"></textarea>
      <button id="mergeBtn">Merge Availability</button>
    </div>

  <script>
    let days = []; // will now be array of Date objects
    let hours = [];
    const allUserAvailability = {};
    let combinedMode = false;
    let prevName = "";
    let allTimezones = [];
    let pageTitle = "Availability Calendar";

    document.addEventListener("DOMContentLoaded", () => {
      parseHash();
      renderPageTitle();
      initTimezoneInput();
      initCurrentUser();
      renderCalendar();
      setupControls();
      updateJsonOutput();
      // Re-parse hash when it changes (e.g., user edits URL and presses enter)
      window.addEventListener("hashchange", () => {
        // Reset state
        days = [];
        hours = [];
        for (const k in allUserAvailability) delete allUserAvailability[k];
        combinedMode = false;
        prevName = "";
        pageTitle = "";
        parseHash();
        renderPageTitle();
        initCurrentUser();
        renderCalendar();
        updateJsonOutput();
      });
    });

    function parseHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      if (params.has("days")) {
        const range = params.get("days");
        const parts = range.split(",");
        if (parts.length === 2) {
          const start = new Date(parts[0]);
          const end = new Date(parts[1]);
          if (!isNaN(start) && !isNaN(end) && start <= end) {
            const d = new Date(start);
            while (d <= end) {
              days.push(new Date(d)); // store Date object
              d.setUTCDate(d.getUTCDate() + 1);
            }
          }
        }
      }
      if (params.has("hours")) {
        const range = params.get("hours");
        const parts = range.split("-").map(s => parseInt(s, 10));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parts[0] <= parts[1]) {
          for (let h = parts[0]; h <= parts[1]; h++) hours.push(h);
        }
      }
      if (days.length === 0) {
        const today = new Date();
        for (let i = 0; i < 7; i++) {
          const d = new Date(today.getTime() + i * 86400000);
          days.push(new Date(d));
        }
      }
      if (hours.length === 0) hours = Array.from({length:24}, (_,i) => i);

      if (params.has("data")) {
        try {
          const decoded = atob(params.get("data"));
          const obj = JSON.parse(decoded);
          Object.assign(allUserAvailability, obj);
          combinedMode = true;
        } catch {}
      }
      if (params.has("title")) {
        try {
          pageTitle = decodeURIComponent(params.get("title").replace(/\+/g, " "));
        } catch {
          pageTitle = params.get("title");
        }
      }
    }

    function initTimezoneInput() {
      const tzInput = document.getElementById("timezoneInput");
      const tzList = document.getElementById("timezoneList");
      const allTimezones = Intl.supportedValuesOf("timeZone");
      // Populate datalist
      allTimezones.forEach(tz => {
        const opt = document.createElement("option"); opt.value = tz;
        tzList.appendChild(opt);
      });
      const userTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
      tzInput.value = userTZ;
      tzInput.addEventListener("change", () => {
        if (!allTimezones.includes(tzInput.value)) tzInput.value = userTZ;
        renderCalendar();
      });
    }

    function initCurrentUser() {
      const name = getCurrentName();
      if (!allUserAvailability[name]) {
        allUserAvailability[name] = {};
      }
      prevName = name;
      renderCombinedUsersList();
    }

    function getCurrentName() {
      const val = document.getElementById("nameInput").value.trim();
      return val ? val : "Anonymous";
    }

    function setupControls() {
      const nameInput = document.getElementById("nameInput");
      nameInput.addEventListener("focus", () => { prevName = getCurrentName(); });
      nameInput.addEventListener("input", () => {
        const newName = getCurrentName();
        if (newName !== prevName) {
          const data = allUserAvailability[prevName] || {};
          let finalName = newName;
          let counter = 1;
          while (allUserAvailability[finalName] && finalName !== prevName) {
            counter++; finalName = `${newName}-${counter}`;
          }
          delete allUserAvailability[prevName];
          allUserAvailability[finalName] = data;
          prevName = finalName;
          document.getElementById("nameInput").value = finalName;
          renderCombinedUsersList();
        }
        combinedMode = true;
        renderCalendar(); updateJsonOutput();
      });

      document.getElementById("copyJsonBtn").addEventListener("click", () => {
        // Copy the JSON as displayed (custom formatted)
        const jsonStr = customJsonStringify(allUserAvailability);
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(jsonStr);
        } else {
          const temp = document.createElement("textarea");
          temp.value = jsonStr;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand("copy");
          document.body.removeChild(temp);
        }
      });

      document.getElementById("copyUrlBtn").addEventListener("click", () => {
        // Only include start and end days in the URL
        const baseJson = btoa(JSON.stringify(allUserAvailability));
        const hashParts = [];
        if (pageTitle) {
          hashParts.push(`title=${encodeURIComponent(pageTitle)}`);
        }
        if (days.length > 0) {
          hashParts.push(`days=${days[0].toISOString().substring(0,10)},${days[days.length-1].toISOString().substring(0,10)}`);
        }
        if (hours.length > 0) {
          hashParts.push(`hours=${hours[0]}-${hours[hours.length-1]}`);
        }
        hashParts.push(`data=${baseJson}`);
        // Use file:// for local files, otherwise use location.origin
        let baseUrl;
        if (location.origin === "null" && location.protocol === "file:") {
          baseUrl = `file://${location.pathname}`;
        } else {
          baseUrl = `${location.origin}${location.pathname}`;
        }
        const newUrl = `${baseUrl}#${hashParts.join("&")}`;
        navigator.clipboard.writeText(newUrl);
      });

      document.getElementById("mergeBtn").addEventListener("click", () => {
        const text = document.getElementById("jsonInput").value.trim(); if (!text) return;
        try {
          const obj = JSON.parse(text);
          Object.entries(obj).forEach(([name, avail]) => {
            let finalName = name;
            let counter = 1;
            while (allUserAvailability[finalName]) { counter++; finalName = `${name}-${counter}`; }
            allUserAvailability[finalName] = avail;
          });
          combinedMode = true;
          renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
        } catch { alert("Invalid JSON. Expecting object keyed by names."); }
      });
    }

    function renderCalendar() {
      const container = document.getElementById("calendarContainer"); container.innerHTML = "";
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      const emptyTh = document.createElement("th"); emptyTh.textContent = ""; headerRow.appendChild(emptyTh);
      days.forEach(day => {
        const th = document.createElement("th");
        const weekday = day.toLocaleDateString(undefined, {weekday: 'short', timeZone: 'UTC'});
        const dayStr = day.toISOString().substring(0, 10);
        th.innerHTML = `<div>${weekday}</div><div>${dayStr}</div>`;
        th.addEventListener("click", () => toggleColumn(day));
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow); table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const tz = document.getElementById("timezoneInput").value;
      hours.forEach(hour => {
        const tr = document.createElement("tr");
        const labelTh = document.createElement("th");
        const sample = new Date(Date.UTC(days[0].getUTCFullYear(), days[0].getUTCMonth(), days[0].getUTCDate(), hour));
        const localTime = sample.toLocaleTimeString("en-US", {hour: "2-digit", minute: "2-digit", timeZone: tz, hour12: false});
        labelTh.textContent = localTime;
        labelTh.addEventListener("click", () => toggleRow(hour));
        tr.appendChild(labelTh);

        days.forEach(day => {
          const td = document.createElement("td");
          const dayStr = day.toISOString().substring(0, 10);
          const hh = hour.toString().padStart(2,'0');
          const key = `${dayStr}|${hh}`;
          const { status, users } = getCellData(key);
          setCellClass(td, status);
          users.forEach(u => {
            const span = document.createElement("span");
            span.textContent = u.name;
            span.classList.add("user-label");
            span.style.color = u.status === 2 ? "#b71c1c" : "#e65100";
            td.appendChild(span);
          });
          td.addEventListener("click", () => {
            const currentName = getCurrentName();
            const userAvail = allUserAvailability[currentName];
            if (!userAvail[dayStr]) userAvail[dayStr] = {};
            const cur = userAvail[dayStr][hh] === undefined ? 0 : userAvail[dayStr][hh] === "not great" ? 1 : 2;
            const nextStatus = (cur + 1) % 3;
            if (nextStatus === 0) delete userAvail[dayStr][hh]; else userAvail[dayStr][hh] = nextStatus === 1 ? "not great" : "bad";
            if (userAvail[dayStr] && Object.keys(userAvail[dayStr]).length === 0) delete userAvail[dayStr];
            combinedMode = true;
            renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
          });
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function getCellData(key) {
      let worst = 0;
      const users = [];
      Object.entries(allUserAvailability).forEach(([name, avail]) => {
        const [day, hh] = key.split("|");
        const dayObj = avail[day] || {};
        const statusStr = dayObj[hh];
        if (statusStr) {
          const st = statusStr === "not great" ? 1 : 2;
          if (st > worst) worst = st;
          users.push({ name, status: st });
        }
      });
      return { status: worst, users };
    }

    function setCellClass(td, status) {
      td.classList.remove("status-good", "status-notgreat", "status-bad");
      if (status === 0) td.classList.add("status-good");
      else if (status === 1) td.classList.add("status-notgreat");
      else if (status === 2) td.classList.add("status-bad");
    }

    function toggleColumn(day) {
      const currentName = getCurrentName();
      const userAvail = allUserAvailability[currentName];
      const dayStr = day.toISOString().substring(0, 10);
      // Determine current status for the column (use first hour as reference)
      let firstStatus = 0;
      if (userAvail[dayStr]) {
        const hh = hours[0].toString().padStart(2, '0');
        const cur = userAvail[dayStr][hh] === undefined ? 0 : userAvail[dayStr][hh] === "not great" ? 1 : 2;
        firstStatus = cur;
      }
      const nextStatus = (firstStatus + 1) % 3;
      hours.forEach(hour => {
        const hh = hour.toString().padStart(2,'0');
        if (!userAvail[dayStr]) userAvail[dayStr] = {};
        if (nextStatus === 0) {
          delete userAvail[dayStr][hh];
        } else {
          userAvail[dayStr][hh] = nextStatus === 1 ? "not great" : "bad";
        }
      });
      if (userAvail[dayStr] && Object.keys(userAvail[dayStr]).length === 0) delete userAvail[dayStr];
      combinedMode = true; renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
    }

    function toggleRow(hour) {
      const currentName = getCurrentName();
      const userAvail = allUserAvailability[currentName];
      const hh = hour.toString().padStart(2, '0');
      // Determine current status for the row (use first day as reference)
      let firstStatus = 0;
      const firstDayStr = days[0].toISOString().substring(0, 10);
      if (userAvail[firstDayStr]) {
        const cur = userAvail[firstDayStr][hh] === undefined ? 0 : userAvail[firstDayStr][hh] === "not great" ? 1 : 2;
        firstStatus = cur;
      }
      const nextStatus = (firstStatus + 1) % 3;
      days.forEach(day => {
        const dayStr = day.toISOString().substring(0, 10);
        if (!userAvail[dayStr]) userAvail[dayStr] = {};
        if (nextStatus === 0) {
          delete userAvail[dayStr][hh];
        } else {
          userAvail[dayStr][hh] = nextStatus === 1 ? "not great" : "bad";
        }
        if (userAvail[dayStr] && Object.keys(userAvail[dayStr]).length === 0) delete userAvail[dayStr];
      });
      combinedMode = true; renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
    }

    // Custom JSON formatter: indent first 2 levels, then hours on one line
    function customJsonStringify(obj) {
      function isHourDict(val) {
        // Heuristic: all keys are 2-digit numbers (00-23) and values are string or undefined
        if (!val || typeof val !== "object" || Array.isArray(val)) return false;
        const keys = Object.keys(val);
        if (keys.length === 0) return false;
        return keys.every(
          k => /^\d\d$/.test(k) && (typeof val[k] === "string" || typeof val[k] === "undefined")
        );
      }

      function format(obj, level) {
        if (level === 2 && isHourDict(obj)) {
          // Print all hours on one line
          const entries = Object.entries(obj)
            .map(([k, v]) => `"${k}": ${v === undefined ? "null" : JSON.stringify(v)}`);
          return `{ ${entries.join(", ")} }`;
        }
        if (Array.isArray(obj)) {
          return (
            "[\n" +
            obj.map(v => "  ".repeat(level + 1) + format(v, level + 1)).join(",\n") +
            "\n" +
            "  ".repeat(level) +
            "]"
          );
        }
        if (obj && typeof obj === "object") {
          const keys = Object.keys(obj);
          if (keys.length === 0) return "{}";
          return (
            "{\n" +
            keys
              .map(
                k =>
                  "  ".repeat(level + 1) +
                  JSON.stringify(k) +
                  ": " +
                  format(obj[k], level + 1)
              )
              .join(",\n") +
            "\n" +
            "  ".repeat(level) +
            "}"
          );
        }
        return JSON.stringify(obj);
      }
      return format(obj, 0);
    }

    function updateJsonOutput() {
      // Use custom formatter for pretty JSON
      const jsonStr = customJsonStringify(allUserAvailability);
      document.getElementById("jsonPretty").innerHTML = syntaxHighlight(jsonStr);
      // Also update the hash when JSON changes (e.g. after merge)
      updateHashFromState();
    }

    // Simple JSON syntax highlighter
    function syntaxHighlight(json) {
      if (!json) return "";
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = "json-number";
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = "json-key";
          } else {
            cls = "json-string";
          }
        } else if (/true|false/.test(match)) {
          cls = "json-boolean";
        } else if (/null/.test(match)) {
          cls = "json-null";
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    function renderCombinedUsersList() {
      const container = document.getElementById("userList"); container.innerHTML = "";
      Object.keys(allUserAvailability).forEach(name => {
        const div = document.createElement("div"); div.classList.add("user-item"); div.textContent = name;
        div.addEventListener("click", () => {
          document.getElementById("nameInput").value = name;
          prevName = name;
        });
        const cross = document.createElement("span"); cross.textContent = "Ã—"; cross.classList.add("remove-user");
        cross.addEventListener("click", (e) => {
          e.stopPropagation();
          if (name === getCurrentName()) return;
          delete allUserAvailability[name];
          if (Object.keys(allUserAvailability).length <= 1) combinedMode = false;
          renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
        });
        div.appendChild(cross);
        container.appendChild(div);
      });
      // New user button
      const newBtn = document.createElement("div");
      newBtn.classList.add("new-user-btn");
      newBtn.textContent = "New user";
      newBtn.addEventListener("click", () => {
        let base = "Anonymous";
        let finalName = base;
        let counter = 1;
        while (allUserAvailability[finalName]) { counter++; finalName = `${base}-${counter}`; }
        allUserAvailability[finalName] = {};
        document.getElementById("nameInput").value = finalName;
        prevName = finalName;
        combinedMode = true;
        renderCalendar(); updateJsonOutput(); renderCombinedUsersList();
      });
      container.appendChild(newBtn);
    }

    function renderPageTitle() {
      const el = document.getElementById("pageTitle");
      el.textContent = pageTitle;
    }
  </script>
  <!-- The following line will be updated by the git hook -->
<div style="text-align:center;color:#888;font-size:13px;margin-top:32px;">Last updated: Wed, 04 Jun 2025 17:56:58 +0100 <!-- LAST_COMMIT_TIME: Wed, 04 Jun 2025 17:56:58 +0100 --></div>
</body>
</html>
